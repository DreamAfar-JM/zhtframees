<!DOCTYPE html>
<!-- saved from url=(0035)http://jizhenfang.sinaapp.com/?p=17 -->
<html class="no-js"><!--<![endif]--><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <style type="text/css"></style>						<title>Hibernate Validator实践之一 入门篇 - 莱昂不纳多</title>			
														<meta name="keywords" content="">
		<meta name="description" content="在后台的业务逻辑中，对数据值的校验在各层都存在（展示层，业务层，数据访问层等），并且各层校验的规则又不尽相同，如下图所示



注：该图片来自于Hibernate Validator官网

在各层中重复的校验逻辑既导致">
		<meta name="viewport" content="initial-scale=1.0,user-scalable=no">
		<link rel="shortcut icon" href="http://jizhenfang.sinaapp.com/favicon.ico" type="image/x-icon">
		<link rel="alternate" type="application/rss+xml" title="莱昂不纳多 » Feed" href="http://jizhenfang.sinaapp.com/?feed=rss2">
<link rel="alternate" type="application/rss+xml" title="莱昂不纳多 » 评论 Feed" href="http://jizhenfang.sinaapp.com/?feed=comments-rss2">
<link rel="alternate" type="application/rss+xml" title="莱昂不纳多 » Hibernate Validator实践之一 入门篇 评论 Feed" href="http://jizhenfang.sinaapp.com/?feed=rss2&p=17">
<link rel="stylesheet" id="wp-syntax-css-css" href="./Hibernate Validator实践之一 入门篇 - 莱昂不纳多_files/wp-syntax.css" type="text/css" media="all">
<link rel="stylesheet" id="normalize-css" href="./Hibernate Validator实践之一 入门篇 - 莱昂不纳多_files/normalize.css" type="text/css" media="screen">
<link rel="stylesheet" id="style-css" href="./Hibernate Validator实践之一 入门篇 - 莱昂不纳多_files/style.css" type="text/css" media="screen">
<script type="text/javascript" src="./Hibernate Validator实践之一 入门篇 - 莱昂不纳多_files/html5shiv.js"></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://jizhenfang.sinaapp.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://jizhenfang.sinaapp.com/wp-includes/wlwmanifest.xml"> 
<link rel="next" title="JNI的实践与应用" href="http://jizhenfang.sinaapp.com/?p=54">
<meta name="generator" content="WordPress 3.4.1">
<link rel="canonical" href="./Hibernate Validator实践之一 入门篇 - 莱昂不纳多_files/Hibernate Validator实践之一 入门篇 - 莱昂不纳多.html">
	<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
	<script src="./Hibernate Validator实践之一 入门篇 - 莱昂不纳多_files/share.js"></script><link rel="stylesheet" href="http://bdimg.share.baidu.com/static/api/css/slide_share.css?v=f905722c.css"><style id="style-1-cropbar-clipper">/* Copyright 2014 Evernote Corporation. All rights reserved. */
.en-markup-crop-options {
    top: 18px !important;
    left: 50% !important;
    margin-left: -100px !important;
    width: 200px !important;
    border: 2px rgba(255,255,255,.38) solid !important;
    border-radius: 4px !important;
}

.en-markup-crop-options div div:first-of-type {
    margin-left: 0px !important;
}
</style></head>
<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                <a id="logo" href="http://jizhenfang.sinaapp.com/">
                   莱昂不纳多                </a>
        	    <p class="description">业精于勤， 荒于嬉； 行成于思， 毁于随。</p>
            </div>
            <div>
                <div class="menu"></div>
            </div>
        </div>
    </div>
</header>
<div id="body">
    <div class="container">
        <div class="col-group">
<div class="col-8" id="main">
	<div class="res-cons">
					<article class="post">
				<h1 class="post-title">Hibernate Validator实践之一 入门篇</h1>
				<ul class="post-meta">
					<li>八月 11, 2014</li>
					<li class="comment-count"><a href="http://jizhenfang.sinaapp.com/?p=17#respond" title="《Hibernate Validator实践之一 入门篇》上的评论">0 条评论</a></li>
				</ul>
				<div class="post-content">
					<p>在后台的业务逻辑中，对数据值的校验在各层都存在（展示层，业务层，数据访问层等），并且各层校验的规则又不尽相同，如下图所示</p>
<p><img class="alignnone" title="Custom Validation" src="./Hibernate Validator实践之一 入门篇 - 莱昂不纳多_files/application-layers.png" alt="" width="650" height="280"></p>
<p>注：该图片来自于Hibernate Validator官网</p>
<p>在各层中重复的校验逻辑既导致了不必要的资源消耗，还使得逻辑不够单一（每层都夹杂着校验的逻辑），JSR 303 Bean Validation就是在这种背景下产生的一个数据验证的J2EE规范。而我们这篇文中将要介绍的Hibernate Validator则是JBoss社区开源的一个JSR 303 &nbsp;Bean Validation规范的优秀实践。</p>
<p><img class="alignnone" title="JSR 303" src="./Hibernate Validator实践之一 入门篇 - 莱昂不纳多_files/application-layers2.png" alt="" width="650" height="346"></p>
<p>注：该图片来自于Hibernate Validator官网</p>
<p>下面我们以一个具体的列子讲述下如何在我们的工程中使用Hibernate Validator</p>
<p>首先我们定义了一个结构体Person，具体的定义如下<br>
<code>public class Person {<br>
@NotNull<br>
private String name;<br>
@Min(value = 1)<br>
private int age;<br>
@NotNull(groups = Intf1.class)<br>
@Size(min = 1, max = 3, groups = Intf2.class)<br>
private String group;<br>
@GenderCase(value = GenderType.FEMALE)<br>
private GenderType gender;<br>
@Max(100)<br>
public int getAge() {<br>
return age;<br>
}<br>
@Max(50)<br>
public int getAgeOther() {<br>
return age + 2;<br>
}<br>
@Max(50)<br>
public int getAgeOther(int num) {<br>
return 51;<br>
}<br>
public Person(String name, int age) {<br>
this.name = name;<br>
this.age = age;<br>
}<br>
}</code></p>
<p>其中该类中用到Max，Min，NotNull，Size等都是JSR 303中内置的约束条件（constraint），GenderCase是自定义的约束条件，这个在后面会介绍。</p>
<p>对Bean进行约束校验，首先需要先获得一个校验器实例<br>
<code>ValidatorFactory factory = Validation.buildDefaultValidatorFactory();<br>
Validator validator = factory.getValidator();<br>
</code></p>
<p><strong>（一）如何对JSR 303 内置的约束条件进行校验</strong><br>
根据上面Person结构体的定义，我们看个简单的例子<br>
<code>Person person = new Person(null, 20);<br>
Set&lt;ConstraintViolation&lt;Person&gt;&gt; constraintViolations = validator.validate(person);<br>
assertEquals(1, constraintViolations.size());<br>
System.out.println(constraintViolations);</code></p>
<p>在Person结构体定义中，name不可以为null，这里我们故意构造了一个name的null的Person实例，结果在控制台输入的结果如下：</p>
<p>[ConstraintViolationImpl{interpolatedMessage='不能为null', propertyPath=name, rootBeanClass=class hibernate.validator.Person, messageTemplate='{javax.validation.constraints.NotNull.message}'}]</p>
<p>从上面的例子可以看出，只需要在定义结构体中将JSR 303 内置的约束注解添加到对应的属性上，通过Validator实例的validate方法，如果返回的Set集合不为空，通过遍历集合便可知哪些属性的值非法。</p>
<p>Bean Validation 中的 constraint<br>
表 1. Bean Validation 中内置的 constraint<br>
@Null 被注释的元素必须为 null<br>
@NotNull 被注释的元素必须不为 null<br>
@AssertTrue 被注释的元素必须为 true<br>
@AssertFalse 被注释的元素必须为 false<br>
@Min(value) 被注释的元素必须是一个数字，其值必须大于等于指定的最小值<br>
@Max(value) 被注释的元素必须是一个数字，其值必须小于等于指定的最大值<br>
@DecimalMin(value) 被注释的元素必须是一个数字，其值必须大于等于指定的最小值<br>
@DecimalMax(value) 被注释的元素必须是一个数字，其值必须小于等于指定的最大值<br>
@Size(max, min) 被注释的元素的大小必须在指定的范围内<br>
@Digits (integer, fraction) 被注释的元素必须是一个数字，其值必须在可接受的范围内<br>
@Past 被注释的元素必须是一个过去的日期<br>
@Future 被注释的元素必须是一个将来的日期<br>
@Pattern(value) 被注释的元素必须符合指定的正则表达式<br>
表 2. Hibernate Validator 附加的 constraint<br>
@Email 被注释的元素必须是电子邮箱地址<br>
@Length 被注释的字符串的大小必须在指定的范围内<br>
@NotEmpty 被注释的字符串的必须非空<br>
@Range 被注释的元素必须在合适的范围内</p>
<p>注：上面两个表格中的内容来自于<a href="http://www.ibm.com/developerworks/cn/java/j-lo-jsr303/index.html">这里</a>，<br>
如果有结构体嵌套，只需要在复合属性上通过Valid注解，则可以递归的进行校验。</p>
<p><strong>（二）validateValue与validateProperty</strong><br>
通过javax.validation.Validator接口类的定义可知，校验的方法有三个，分别是validate，validateProperty，validateValue。其中validate会将所有的属性进行约束校验，而validateProperty是针对某一个具体的属性进行校验，validateValue是对具体的某一个属性和特定的值进行校验。具体看下面的两个例子</p>
<p>第一个例子：</p>
<p><code>Person person = new Person(null, 101);<br>
Set&lt;ConstraintViolation&lt;Person&gt;&gt; constraintViolations = validator.validateProperty(person, "age");<br>
assertEquals(1, constraintViolations.size());<br>
System.out.println(constraintViolations);</code></p>
<p>根据上面的结构定义可以看出来在Person结构体中对age的约束有两个，一个是最小值为1，另一个是个getter方法上的约束最大不能超过100，执行上面的逻辑输出的结果为：</p>
<p>[ConstraintViolationImpl{interpolatedMessage='最大不能超过100', propertyPath=age, rootBeanClass=class hibernate.validator.Person, messageTemplate='{javax.validation.constraints.Max.message}'}]</p>
<p>可见validateProperty不光是对field的值进行校验，还会对getter方法也进行校验。</p>
<p>第二个例子：</p>
<p><code>Set&lt;ConstraintViolation&lt;Person&gt;&gt; constraintViolations = validator.validateValue(Person.class, "name", null);<br>
assertEquals(1, constraintViolations.size());<br>
System.out.println(constraintViolations);</code></p>
<p>第二个例子表示在执行validateValue时，给定一个结构体定义，field的名称，看该特定的值是否符合约束，执行的结果如下：</p>
<p>[ConstraintViolationImpl{interpolatedMessage='不能为null', propertyPath=name, rootBeanClass=class hibernate.validator.Person, messageTemplate='{javax.validation.constraints.NotNull.message}'}]</p>
<p><strong>（三）约束条件的分组</strong><br>
在JSR 303 中定义了group的概念，用定义的接口类来标识，在上面的Person结构体定义的例子中可以看出有个group属性，该属性上有两个约束，分别是@NotNull(groups = Intf1.class) 和@Size(min = 1, max = 3, groups = Intf2.class)</p>
<p>下面通过一段代码执行的结果来看在参数校验中如何进行分组</p>
<p><code>Set&lt;ConstraintViolation&lt;Person&gt;&gt; constraintViolations = validator.validateValue(Person.class, "group", null, Intf1.class);<br>
assertEquals(1, constraintViolations.size());<br>
System.out.println("validate Intf1 |" + constraintViolations);<br>
constraintViolations = validator.validateValue(Person.class, "group",null, Intf2.class);<br>
assertEquals(0, constraintViolations.size());<br>
System.out.println("validate Intf2 |" + constraintViolations);<br>
constraintViolations = validator.validateValue(Person.class, "group","test", Intf2.class, Intf1.class);<br>
assertEquals(1, constraintViolations.size());<br>
System.out.println("validate Intf1&amp;Intf2 |" + constraintViolations);</code></p>
<p>上段逻辑当group值为null时，首先用Intf1标识的约束条件进行校验，在用Intf2标识的约束条件进行校验。当group值为test时，同时用Intf1和Intf2标识的约束条件进行校验。执行的结果如下：</p>
<p>validate Intf1 | [ConstraintViolationImpl{interpolatedMessage='不能为null', propertyPath=group, rootBeanClass=class hibernate.validator.Person, messageTemplate='{javax.validation.constraints.NotNull.message}'}]<br>
validate Intf2 | []<br>
validate Intf1&amp;Intf2 | [ConstraintViolationImpl{interpolatedMessage='个数必须在1和3之间', propertyPath=group, rootBeanClass=class hibernate.validator.Person, messageTemplate='{javax.validation.constraints.Size.message}'}]</p>
<p>从上面的例子可以看出，可以根据具体的业务选择不同的校验规则。</p>
<p><strong>（四）约束条件的定制</strong><br>
对约束条件的定制，需要两步，第一步是定义约束的注解类：</p>
<p><code>@Target({ ElementType.METHOD, ElementType.FIELD, ElementType.ANNOTATION_TYPE })<br>
@Retention(RetentionPolicy.RUNTIME)<br>
@Constraint(validatedBy = GenderTypeValidator.class)<br>
public @interface GenderCase {<br>
String message() default "genderType invalid";<br>
Class&lt;?&gt;[] groups() default {};<br>
Class&lt;? extends Payload&gt;[] payload() default {};<br>
GenderType value() default GenderType.FEMALE;<br>
}</code></p>
<p>这里需要关注的有三个点，第一个是@Constraint(validatedBy = GenderTypeValidator.class) 这里指定了下面将要说的约束校验的实现类，第二个是message属性，用于校验值非法是缺省的消息模版，第三个是注解对应的约束值value。在这个例子中，注解的约束值用的是一个枚举值表示男/女，缺省值为女</p>
<p>第二步是实现了javax.validation.ConstraintValidator&lt;A extends Annotation, T&gt;接口的约束校验实现类，上面说的validatedBy指向的就是该实现类，其中A表示自定义的注解类，T表示进行校验的字段的类型。具体的逻辑定于如下：</p>
<p><code>public class GenderTypeValidator implements<br>
ConstraintValidator&lt;GenderCase, GenderType&gt; {<br>
GenderType value;<br>
@Override<br>
public void initialize(GenderCase constraintAnnotation) {<br>
value = constraintAnnotation.value();<br>
}<br>
@Override<br>
public boolean isValid(GenderType obj, ConstraintValidatorContext context) {<br>
if (value != null &amp;&amp; obj != null &amp;&amp; value != obj) {<br>
context.disableDefaultConstraintViolation();<br>
context.buildConstraintViolationWithTemplate("gender should be " + value + "| the value is " + obj).addConstraintViolation();<br>
return false;<br>
} else {<br>
return true;<br>
}<br>
}<br>
}</code></p>
<p>在初始化方法中获取该注解的约束条件，在isValid方法中将传进来的obj的值与约束条件比较，如果满足则返回true表示校验通过，如果不满足则返回false，并将错误信息存储上上下文ConstraintValidatorContext中，最终反馈给调用者。</p>
<p>下面是调用该定制约束条件的逻辑：</p>
<p><code>Set&lt;ConstraintViolation&lt;Person&gt;&gt; constraintViolations = validator.validateValue(Person.class, "gender", GenderType.MALE);<br>
assertEquals(1, constraintViolations.size());<br>
System.out.println(constraintViolations);</code></p>
<p>执行的结果如下：</p>
<p>[ConstraintViolationImpl{interpolatedMessage='gender should be FEMALE| the value is MALE', propertyPath=gender, rootBeanClass=class hibernate.validator.Person, messageTemplate='gender should be FEMALE| the value is MALE'}]</p>
<p><script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["weixin","tsina","renren","douban","tqq","qzone","kaixin001","youdao","tsohu","t163","qingbiji","mail","fbook","twi","deli","linkedin","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"5","bdPos":"left","bdTop":"150"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script></p>
				</div>
			</article>
				<div id="comments">
    
                   
    
        <div id="respond" class="respond">
        <div class="cancel-comment-reply">
        <a rel="nofollow" id="cancel-comment-reply-link" href="http://jizhenfang.sinaapp.com/?p=17#respond" style="display:none;">点击这里取消回复。</a>        </div>
    	<h3 id="response">添加新评论</h3>
    	<form method="post" action="http://jizhenfang.sinaapp.com/wp-comments-post.php" id="comment_form">
			<div class="col1">
			<p>
                <textarea rows="8" cols="50" name="comment" class="textarea"></textarea>
            </p>
			</div>
			<div class="col2">
                		<p>
                <label for="author" class="required">称呼</label>
    			<input type="text" name="author" id="author" class="text" value="">
    		</p>
    		<p>
                <label for="mail" class="required">邮箱</label>
    			<input type="email" name="email" id="mail" class="text" value="">
    		</p>
    		<p>
                <label for="url">网站</label>
    			<input type="url" name="url" id="url" class="text" placeholder="http://example.com" value="">
    		</p>
                		<p>
                <button type="submit" name="submit" class="submit">提交评论</button>
            </p>
			</div>
			<div class="clear"></div>
            <input type="hidden" name="comment_post_ID" value="17" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">
 
                        
    	</form>
    </div>
    </div>	</div>
</div>
<div id="secondary">
	<section class="widget">
        <form id="search" method="get" action="http://jizhenfang.sinaapp.com/">
			<input type="text" name="s" class="text" placeholder="输入关键字搜索">
			<button type="submit" class="submit">搜索</button>
        </form>
    </section>
	<section id="search-2" class="widget widget_search"><form role="search" method="get" id="searchform" action="http://jizhenfang.sinaapp.com/">
	<div><label class="screen-reader-text" for="s">搜索：</label>
	<input type="text" value="" name="s" id="s">
	<input type="submit" id="searchsubmit" value="搜索">
	</div>
	</form></section>		<section id="recent-posts-2" class="widget widget_recent_entries">		<h3 class="widget-title">近期文章</h3>		<ul>
				<li><a href="http://jizhenfang.sinaapp.com/?p=138" title="《Java线程面试题 Top 50》读书札记之一">《Java线程面试题 Top 50》读书札记之一</a></li>
				<li><a href="http://jizhenfang.sinaapp.com/?p=54" title="JNI的实践与应用">JNI的实践与应用</a></li>
				<li><a href="./Hibernate Validator实践之一 入门篇 - 莱昂不纳多_files/Hibernate Validator实践之一 入门篇 - 莱昂不纳多.html" title="Hibernate Validator实践之一 入门篇">Hibernate Validator实践之一 入门篇</a></li>
				</ul>
		</section><section id="recent-comments-2" class="widget widget_recent_comments"><h3 class="widget-title">近期评论</h3><ul id="recentcomments"></ul></section><section id="archives-2" class="widget widget_archive"><h3 class="widget-title">文章归档</h3>		<ul>
			<li><a href="http://jizhenfang.sinaapp.com/?m=201410" title="2014 年十月">2014 年十月</a></li>
	<li><a href="http://jizhenfang.sinaapp.com/?m=201409" title="2014 年九月">2014 年九月</a></li>
	<li><a href="http://jizhenfang.sinaapp.com/?m=201408" title="2014 年八月">2014 年八月</a></li>
		</ul>
</section><section id="categories-2" class="widget widget_categories"><h3 class="widget-title">分类目录</h3>		<ul>
	<li class="cat-item cat-item-3"><a href="http://jizhenfang.sinaapp.com/?cat=3" title="Java虚拟机的高级特性">Effective Java</a>
</li>
	<li class="cat-item cat-item-1"><a href="http://jizhenfang.sinaapp.com/?cat=1" title="查看 Hibernate Validator 下的所有文章">Hibernate Validator</a>
</li>
	<li class="cat-item cat-item-4"><a href="http://jizhenfang.sinaapp.com/?cat=4" title="文章、书籍等的阅读笔记">读书札记</a>
</li>
		</ul>
</section><section id="meta-2" class="widget widget_meta"><h3 class="widget-title">功能</h3>			<ul>
						<li><a href="http://jizhenfang.sinaapp.com/wp-login.php">登录</a></li>
			<li><a href="http://jizhenfang.sinaapp.com/?feed=rss2" title="使用 RSS 2.0 订阅本站点内容">文章 <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://jizhenfang.sinaapp.com/?feed=comments-rss2" title="使用 RSS 订阅本站点的所有文章的近期评论">评论 <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://cn.wordpress.org/" title="基于 WordPress，一个优美、先进的个人信息发布平台。">WordPress.org</a></li>
						</ul>
</section>    
</div>		</div>
    </div>
</div>
<footer id="footer">
	<div class="container">
		© 2015 <a href="http://jizhenfang.sinaapp.com/">莱昂不纳多</a>.
	</div>
</footer>

<div class="bdshare-slide-button-box bdshare-slide-style-l5" style="top: 150px; width: 0px; z-index: 99999; left: 0px;" data-bd-bind="1423219271540"><a href="http://jizhenfang.sinaapp.com/?p=17#" onclick="return false;" class="bdshare-slide-button" style="right: -24px;"></a><div class="bdshare-slide-list-box" style="width: 0px; display: none;"><div class="bdshare-slide-top">分享到</div><div class="bdshare-slide-list"><ul class="bdshare-slide-list-ul" style="width: 226px;"></ul></div><div class="bdshare-slide-bottom" style="width: 226px;"><a href="http://jizhenfang.sinaapp.com/?p=17#" onclick="return false;" class="slide-more" data-cmd="more">更多...</a></div></div></div></body></html>